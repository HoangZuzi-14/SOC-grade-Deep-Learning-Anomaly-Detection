version: '3.8'

# Production docker-compose with PostgreSQL
services:
  api:
    build:
      context: .
      dockerfile: Dockerfile.api
    container_name: soc-anomaly-api-prod
    ports:
      - "8000:8000"
    volumes:
      - ./model:/app/model:ro
      - ./data:/app/data
    environment:
      - MODEL_PATH=/app/model/model.pth
      - SCORES_PATH=/app/data/sequences/lstm_scores.pkl
      - MAPPING_PATH=/app/data/sequences/event_mapping.json
      - DEVICE=cpu
      - DATABASE_URL=postgresql://soc_user:soc_password@postgres:5432/soc_anomaly
    restart: always
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - soc-network
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  dashboard:
    build:
      context: .
      dockerfile: Dockerfile.dashboard
    container_name: soc-anomaly-dashboard-prod
    ports:
      - "80:80"
    depends_on:
      - api
    restart: always
    networks:
      - soc-network

  postgres:
    image: postgres:15-alpine
    container_name: soc-anomaly-db-prod
    environment:
      - POSTGRES_DB=soc_anomaly
      - POSTGRES_USER=soc_user
      - POSTGRES_PASSWORD=soc_password
      - POSTGRES_INITDB_ARGS=--encoding=UTF8
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./docker/init-db.sql:/docker-entrypoint-initdb.d/init.sql:ro
    restart: always
    networks:
      - soc-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U soc_user -d soc_anomaly"]
      interval: 10s
      timeout: 5s
      retries: 5

networks:
  soc-network:
    driver: bridge

volumes:
  postgres_data:
    driver: local
